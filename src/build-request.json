{
  "kind": "build_request",
  "title": "Fix backend video finalization timeout and persistence issues",
  "projectName": "Skeletal Clock",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-87",
      "text": "Optimize the backend finalizeVideoUpload function in backend/main.mo to complete video metadata persistence within 30 seconds by implementing efficient stable storage writes and eliminating any blocking operations that cause timeout failures",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "Upload finalization timed out after 30 seconds. The backend may be experiencing issues."
        ]
      },
      "acceptanceCriteria": [
        "The finalizeVideoUpload function completes successfully within 30 seconds for the 49.1 MB video file",
        "Video metadata is immediately persisted to stable storage after all chunks are received",
        "The function returns success confirmation before the 30-second timeout",
        "No blocking operations prevent timely completion"
      ]
    },
    {
      "id": "REQ-88",
      "text": "Add comprehensive error handling and detailed logging in backend/main.mo finalizeVideoUpload function to capture and return specific error information about storage failures, memory allocation issues, serialization errors, or any other issues preventing video persistence",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-last"
        ]
      },
      "acceptanceCriteria": [
        "All potential error conditions in finalizeVideoUpload are caught and logged",
        "Error messages include specific details about the failure type (storage, memory, serialization, etc.)",
        "Error responses are returned to the frontend with actionable information",
        "Console logs include timing information for debugging performance issues"
      ]
    },
    {
      "id": "REQ-89",
      "text": "Verify and optimize stable memory allocation in backend/main.mo to ensure sufficient capacity for the 49.1 MB video file plus existing application data, and add pre-finalization validation that checks available storage capacity before attempting to persist video data",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-last"
        ]
      },
      "acceptanceCriteria": [
        "Stable memory allocation is sufficient for 49.1 MB video plus existing data",
        "Pre-finalization validation checks available storage capacity",
        "Function returns clear error message if insufficient storage is available",
        "Memory allocation issues do not cause silent failures or timeouts"
      ]
    },
    {
      "id": "REQ-90",
      "text": "Review and optimize the video chunk assembly and persistence logic in backend/main.mo to ensure all 18 chunks of the 49.1 MB video are properly combined and committed to stable storage without data loss or corruption",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-last"
        ]
      },
      "acceptanceCriteria": [
        "All 18 chunks are successfully assembled into complete video data",
        "No data loss or corruption occurs during chunk assembly",
        "Assembled video data is correctly persisted to stable storage",
        "Video metadata accurately reflects the complete video state"
      ]
    },
    {
      "id": "REQ-91",
      "text": "Add backend performance monitoring and timing logs in backend/main.mo finalizeVideoUpload function to track the duration of each operation (chunk assembly, metadata creation, stable storage write, etc.) to identify bottlenecks causing the 30-second timeout",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-last"
        ]
      },
      "acceptanceCriteria": [
        "Each operation in finalizeVideoUpload is timed and logged",
        "Logs clearly show which operation is causing delays",
        "Performance data helps identify optimization opportunities",
        "Timing information is included in error messages when timeout occurs"
      ]
    }
  ],
  "constraints": [
    "Maintain single-actor architecture in backend/main.mo",
    "Do not modify frontend immutable paths: frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useInternetIdentity.tsx, frontend/src/hooks/useActor.ts, frontend/src/main.tsx, frontend/src/components/ui",
    "Preserve existing chunked upload implementation in MasterVideoUploader component",
    "Maintain existing timeout mechanism (30 seconds) in frontend",
    "Do not exceed canister stable memory limits"
  ],
  "nonGoals": [
    "Changing the video file format or compression",
    "Modifying the chunk size or number of chunks",
    "Altering the frontend upload or retry logic",
    "Implementing real-time upload progress streaming from backend",
    "Adding external storage services or CDN integration"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}